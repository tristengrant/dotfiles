local M = {}

-- Paths to check
local server_base = "/misc/files/github/tristengrant-website/src/images/"
local local_base = os.getenv("HOME") .. "/Github/tristengrant-website/src/images/"

-- Scripts
local server_script = "/misc/files/github/scripts/genalt_server.sh"
local local_script = "/home/tristen/Github/scripts/genalt_pc.sh"

-- Normalize path: remove leading slashes
local function normalize(path)
  return path:gsub("^/*", "")
end

function M.insert_alt_text()
  -- Get current line
  local line = vim.api.nvim_get_current_line()

  -- Try to find src={...} inside <Picture>
  local img_path = line:match("src={([%w%p]+)}")
  if not img_path or img_path == "" then
    img_path = vim.fn.input("Image relative path (from src/images/): ")
    if img_path == "" then
      return
    end
  end

  img_path = normalize(img_path)

  local full_server = server_base .. img_path
  local full_local = local_base .. img_path

  local script_path, full_img_path
  if vim.fn.filereadable(full_server) == 1 then
    script_path = server_script
    full_img_path = img_path
  elseif vim.fn.filereadable(full_local) == 1 then
    script_path = local_script
    full_img_path = img_path
  else
    print("Error: File does not exist!")
    print("Checked paths:")
    print("Server: " .. full_server)
    print("Local:  " .. full_local)
    return
  end

  -- Call the script
  local cmd = string.format('%s "%s"', script_path, full_img_path)
  local handle = io.popen(cmd .. " 2>&1")
  local alt_text = handle:read("*a")
  handle:close()
  alt_text = alt_text:gsub("\n$", "")

  -- Insert alt attribute at cursor
  local row, col = unpack(vim.api.nvim_win_get_cursor(0))
  vim.api.nvim_buf_set_text(0, row - 1, col, row - 1, col, { ' alt="' .. alt_text:gsub('"', '\\"') .. '"' })
end

return M
